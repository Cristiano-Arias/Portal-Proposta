<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Envio de Propostas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .processo-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .processo-info input {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .processo-info input#objetoProcesso {
            width: 400px;
        }

        .progress-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #3498db, #2980b9);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 140px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active { background: #3498db; color: white; }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .form-section.active { display: block; }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-row.single { flex-direction: column; }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }

        .required { color: #e74c3c; }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .dynamic-table th,
        .dynamic-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .dynamic-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }

        .dynamic-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-btn:hover { background: #219a52; }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .remove-btn:hover { background: #c0392b; }

        .total-box {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .final-total {
            border-top: 2px solid #3498db;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 18px;
            color: #2c3e50;
        }

        .submit-section {
            text-align: center;
            margin-top: 30px;
        }

        .preview-btn,
        .submit-btn {
            padding: 15px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preview-btn {
            background: #95a5a6;
            color: white;
        }

        .preview-btn:hover { background: #7f8c8d; }

        .submit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .submit-btn:hover { transform: translateY(-2px); }

        .modal-revisao {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-revisao-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-revisao-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-revisao-body {
            padding: 20px;
        }

        .modal-revisao-footer {
            padding: 20px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alerta-revisao {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-voltar-revisao {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-confirmar-envio {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .aviso-cnpj {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }

        .cronograma-info {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
        }

        .prazo-total {
            text-align: right;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Portal de Envio de Propostas</h1>
            <p>Sistema Integrado de Gest√£o de Propostas Comerciais</p>
        </div>

        <div class="processo-info">
            <strong>Processo:</strong> <input type="text" id="numeroProcesso" placeholder="Digite o n√∫mero do processo" style="margin: 0 10px;">
            <strong>Objeto:</strong> <input type="text" id="objetoProcesso" placeholder="Descri√ß√£o do objeto da licita√ß√£o">
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin-top: 10px; font-weight: 600;">
                Progresso: <span id="progressText">0%</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dados')">1. Dados Cadastrais</button>
            <button class="tab" onclick="showTab('tecnica')">2. Proposta T√©cnica</button>
            <button class="tab" onclick="showTab('comercial')">3. Proposta Comercial</button>
            <button class="tab" onclick="showTab('revisao')">4. Revis√£o Final</button>
        </div>

        <!-- SE√á√ÉO 1: DADOS CADASTRAIS -->
        <div class="form-section active" id="dados">
            <div class="section-title">üìã 1. Dados da Empresa</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="razaoSocial">Raz√£o Social <span class="required">*</span></label>
                    <input type="text" id="razaoSocial" required>
                </div>
                <div class="form-group">
                    <label for="cnpj">CNPJ <span class="required">*</span></label>
                    <input type="text" id="cnpj" required>
                    <div id="aviso-cnpj-duplicado" class="aviso-cnpj"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="endereco">Endere√ßo Completo</label>
                    <input type="text" id="endereco">
                </div>
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="text" id="telefone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="respTecnico">Respons√°vel T√©cnico</label>
                    <input type="text" id="respTecnico">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="crea">CREA/CAU</label>
                    <input type="text" id="crea">
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 2: PROPOSTA T√âCNICA -->
        <div class="form-section" id="tecnica">
            <div class="section-title">üìã 2. Proposta T√©cnica</div>

            <div class="section-title">2.1 Objeto da Concorr√™ncia</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="objetoConcorrencia">Descri√ß√£o do Objeto</label>
                    <textarea id="objetoConcorrencia" rows="3" placeholder="Descreva detalhadamente o objeto da concorr√™ncia..."></textarea>
                </div>
            </div>

            <div class="section-title">2.2 Escopo dos Servi√ßos</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="escopoInclusos">Servi√ßos Inclusos</label>
                    <textarea id="escopoInclusos" rows="4" placeholder="Liste todos os servi√ßos inclusos na proposta..."></textarea>
                </div>
            </div>

            <div class="form-row single">
                <div class="form-group">
                    <label for="escopoExclusos">Servi√ßos Exclu√≠dos</label>
                    <textarea id="escopoExclusos" rows="3" placeholder="Liste os servi√ßos que n√£o est√£o inclusos..."></textarea>
                </div>
            </div>

            <div class="section-title">2.3 Metodologia de Execu√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="metodologia">Metodologia</label>
                    <textarea id="metodologia" rows="5" placeholder="Descreva a metodologia que ser√° utilizada para execu√ß√£o dos servi√ßos..."></textarea>
                </div>
            </div>

            <div class="section-title">2.4 Cronograma de Execu√ß√£o Automatizado</div>
            <div class="cronograma-info">
                <strong>üí° Cronograma Inteligente:</strong> Insira apenas a atividade e a dura√ß√£o em dias. 
                As datas de in√≠cio e fim ser√£o calculadas automaticamente de forma sequencial.
            </div>
            
            <table class="dynamic-table" id="cronogramaTable">
                <thead>
                    <tr>
                        <th>Atividade</th>
                        <th>Dura√ß√£o (dias)</th>
                        <th>In√≠cio (Calculado)</th>
                        <th>Fim (Calculado)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Mobiliza√ß√£o" value="Mobiliza√ß√£o"></td>
                        <td><input type="number" placeholder="15" min="1" value="15" onchange="calcularCronograma()"></td>
                        <td><input type="text" readonly value="Dia 1"></td>
                        <td><input type="text" readonly value="Dia 15"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'cronograma')">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addCronogramaRow()">+ Adicionar Atividade</button>
            <div class="prazo-total">
                Prazo Total Calculado: <span id="prazoTotalCronograma">15</span> dias
            </div>

            <div class="section-title">2.5 Prazo de Execu√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="prazoExecucao">Prazo Total</label>
                    <input type="text" id="prazoExecucao" value="15 dias" readonly style="background: #f8f9fa;">
                </div>
            </div>

            <div class="section-title">2.6 Observa√ß√µes T√©cnicas</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes Gerais</label>
                    <textarea id="observacoes" rows="3" placeholder="Observa√ß√µes adicionais sobre a execu√ß√£o t√©cnica..."></textarea>
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 3: PROPOSTA COMERCIAL -->
        <div class="form-section" id="comercial">
            <div class="section-title">üí∞ 3. Proposta Comercial</div>

            <div class="form-group">
                <label for="valorTotal">Valor Total (Calculado Automaticamente)</label>
                <input type="text" id="valorTotal" readonly style="background: #f8f9fa; font-weight: bold; font-size: 16px;">
            </div>

            <div class="section-title">3.1 M√£o de Obra</div>
            <table class="dynamic-table" id="maoObraTable">
                <thead>
                    <tr>
                        <th>Fun√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Valor Unit√°rio (R$)</th>
                        <th>Valor Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Engenheiro"></td>
                        <td><input type="number" placeholder="1" onchange="calcularTotais()"></td>
                        <td><input type="text" placeholder="5.000,00" onchange="calcularTotais()"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'maoObra')">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addRow('maoObraTable')">+ Adicionar Fun√ß√£o</button>
            <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                Total M√£o de Obra: R$ <span id="totalMaoObra">0,00</span>
            </div>

            <div class="section-title">3.2 Materiais</div>
            <table class="dynamic-table" id="materiaisTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Quantidade</th>
                        <th>Valor Unit√°rio (R$)</th>
                        <th>Valor Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Cimento"></td>
                        <td><input type="number" placeholder="100" onchange="calcularTotais()"></td>
                        <td><input type="text" placeholder="25,00" onchange="calcularTotais()"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'materiais')">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addRow('materiaisTable')">+ Adicionar Material</button>
            <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                Total Materiais: R$ <span id="totalMateriais">0,00</span>
            </div>

            <div class="section-title">3.3 Equipamentos</div>
            <table class="dynamic-table" id="equipamentosTable">
                <thead>
                    <tr>
                        <th>Equipamento</th>
                        <th>Quantidade</th>
                        <th>Valor Unit√°rio (R$)</th>
                        <th>Valor Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Betoneira"></td>
                        <td><input type="number" placeholder="1" onchange="calcularTotais()"></td>
                        <td><input type="text" placeholder="500,00" onchange="calcularTotais()"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'equipamentos')">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addRow('equipamentosTable')">+ Adicionar Equipamento</button>
            <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                Total Equipamentos: R$ <span id="totalEquipamentos">0,00</span>
            </div>

            <div class="section-title">3.4 BDI (Benef√≠cios e Despesas Indiretas)</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bdiPercentual">BDI (%)</label>
                    <input type="number" id="bdiPercentual" placeholder="25.0" step="0.1" onchange="calcularTotais()">
                </div>
                <div class="form-group">
                    <label for="bdiValor">Valor BDI (R$)</label>
                    <input type="text" id="bdiValor" readonly style="background: #f8f9fa;">
                </div>
            </div>

            <div class="total-box">
                <div class="total-line">
                    <span>CUSTO DIRETO (MO + Mat + Equip):</span>
                    <span>R$ <span id="custoDirecto">0,00</span></span>
                </div>
                <div class="total-line" style="color: #27ae60;">
                    <span>BDI TOTAL:</span>
                    <span><span id="bdiPercentualDisplay">0.0</span>% = R$ <span id="bdiValorDisplay">0,00</span></span>
                </div>
                <div class="total-line final-total">
                    <span>VALOR TOTAL DA PROPOSTA:</span>
                    <span>R$ <span id="valorTotalCalculado">0,00</span></span>
                </div>
            </div>

            <div class="section-title">3.5 Condi√ß√µes</div>
            <div class="form-group">
                <label for="validadeProposta">Validade da Proposta</label>
                <input type="text" id="validadeProposta" placeholder="60 dias" value="60 dias">
            </div>
            <div class="form-group">
                <label for="validadeDetalhada">Condi√ß√µes Detalhadas</label>
                <textarea id="validadeDetalhada" rows="3" placeholder="Proposta v√°lida por 60 dias. Pre√ßos sujeitos a reajuste ap√≥s este per√≠odo."></textarea>
            </div>
        </div>

        <!-- SE√á√ÉO 4: REVIS√ÉO -->
        <div class="form-section" id="revisao">
            <div class="section-title">üìã 4. Revis√£o Final</div>
            
            <div id="resumoProposta">
                <!-- Conte√∫do gerado automaticamente -->
            </div>
        </div>

        <div class="submit-section">
            <button type="button" class="preview-btn" onclick="gerarPreview()">üëÅÔ∏è Visualizar</button>
            <button type="button" class="submit-btn" onclick="enviarProposta()">üöÄ Enviar Proposta</button>
            
            <div id="mensagem"></div>
        </div>
    </div>

    <!-- Modal de Revis√£o -->
    <div id="modalRevisao" class="modal-revisao">
        <div class="modal-revisao-content">
            <div class="modal-revisao-header">
                <h2>üìã Revis√£o Final da Proposta</h2>
                <button onclick="fecharModalRevisao()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            
            <div class="modal-revisao-body">
                <div class="alerta-revisao">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>
                        <strong>ATEN√á√ÉO:</strong> Revise cuidadosamente todos os dados antes de enviar.
                        Ap√≥s o envio, a proposta n√£o poder√° ser alterada.
                    </div>
                </div>
                
                <div id="conteudoRevisao">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <div class="modal-revisao-footer">
                <button class="btn-voltar-revisao" onclick="fecharModalRevisao()">
                    ‚Üê Voltar e Editar
                </button>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: 600;">
                        <input type="checkbox" id="confirmacaoFinal" onchange="habilitarBotaoEnvio()">
                        Confirmo que todos os dados est√£o corretos
                    </label>
                    
                    <button id="btnConfirmarEnvio" class="btn-confirmar-envio" onclick="confirmarEnvioFinal()" disabled style="opacity: 0.5;">
                        ‚úÖ Confirmar e Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'dados';

        // ===== CRONOGRAMA AUTOM√ÅTICO =====
        function addCronogramaRow() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Nova Atividade"></td>
                <td><input type="number" placeholder="10" min="1" onchange="calcularCronograma()"></td>
                <td><input type="text" readonly></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'cronograma')">√ó</button></td>
            `;
            calcularCronograma();
        }

        function calcularCronograma() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            let diaAtual = 1;
            let prazoTotal = 0;
            
            for (const row of tbody.rows) {
                const duracaoInput = row.cells[1].querySelector('input');
                const duracao = parseInt(duracaoInput.value) || 0;
                
                if (duracao > 0) {
                    const diaFim = diaAtual + duracao - 1;
                    row.cells[2].querySelector('input').value = `Dia ${diaAtual}`;
                    row.cells[3].querySelector('input').value = `Dia ${diaFim}`;
                    diaAtual = diaFim + 1;
                    prazoTotal += duracao;
                } else {
                    row.cells[2].querySelector('input').value = '';
                    row.cells[3].querySelector('input').value = '';
                }
            }
            
            document.getElementById('prazoTotalCronograma').textContent = prazoTotal;
            
            // Atualiza o campo principal de prazo
            const prazoExecucaoInput = document.getElementById('prazoExecucao');
            if (prazoExecucaoInput) {
                prazoExecucaoInput.value = `${prazoTotal} dias`;
            }
        }

        function removeRowAndRecalculate(button, type) {
            button.closest('tr').remove();
            if (type === 'cronograma') {
                calcularCronograma();
            } else {
                calcularTotais();
            }
        }

        // ===== VALIDA√á√ÉO DE CNPJ =====
        document.getElementById('cnpj').addEventListener('blur', async function() {
            const cnpj = this.value.trim();
            const processo = document.getElementById('numeroProcesso').value.trim();
            const avisoDiv = document.getElementById('aviso-cnpj-duplicado');

            if (cnpj && processo) {
                try {
                    const response = await fetch('/api/verificar-cnpj', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ cnpj, processo })
                    });
                    
                    const data = await response.json();
                    
                    if (data.duplicado) {
                        avisoDiv.textContent = `‚ö†Ô∏è Este CNPJ j√° enviou uma proposta para este processo (Protocolo: ${data.protocolo}).`;
                        this.style.borderColor = '#e74c3c';
                    } else {
                        avisoDiv.textContent = '';
                        this.style.borderColor = '';
                    }
                } catch (error) {
                    console.error("Erro ao verificar CNPJ:", error);
                    avisoDiv.textContent = '‚ö†Ô∏è N√£o foi poss√≠vel verificar o CNPJ no momento.';
                }
            } else {
                avisoDiv.textContent = '';
                this.style.borderColor = '';
            }
        });

        // ===== FUN√á√ïES DE FORMATA√á√ÉO =====
        function formatarMoeda(valor) {
            if (!valor && valor !== 0) return '';
            let numero = parseFloat(valor);
            if (isNaN(numero)) return '';
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function parseMoeda(valor) {
            if (typeof valor === 'number') return valor;
            if (typeof valor === 'string') {
                return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return 0;
        }

        // ===== C√ÅLCULO DE VALORES CORRIGIDO =====
        function calcularTotais() {
            // Calcular totais de cada categoria
            const totalMaoObra = calcularTotalTabela('maoObraTable');
            const totalMateriais = calcularTotalTabela('materiaisTable');
            const totalEquipamentos = calcularTotalTabela('equipamentosTable');
            
            // CUSTO DIRETO = APENAS (MO + Mat + Equip) - CONFORME SOLICITA√á√ÉO
            const custoDireto = totalMaoObra + totalMateriais + totalEquipamentos;
            
            // BDI sobre o custo direto
            const bdiPercentual = parseFloat(document.getElementById('bdiPercentual').value) || 0;
            const bdiValor = custoDireto * (bdiPercentual / 100);
            
            // VALOR TOTAL = Custo Direto + BDI
            const valorTotal = custoDireto + bdiValor;
            
            // Atualizar campos
            document.getElementById('totalMaoObra').textContent = formatarMoeda(totalMaoObra);
            document.getElementById('totalMateriais').textContent = formatarMoeda(totalMateriais);
            document.getElementById('totalEquipamentos').textContent = formatarMoeda(totalEquipamentos);
            document.getElementById('custoDirecto').textContent = formatarMoeda(custoDireto);
            document.getElementById('bdiPercentualDisplay').textContent = bdiPercentual.toFixed(1);
            document.getElementById('bdiValorDisplay').textContent = formatarMoeda(bdiValor);
            document.getElementById('bdiValor').value = 'R$ ' + formatarMoeda(bdiValor);
            document.getElementById('valorTotalCalculado').textContent = formatarMoeda(valorTotal);
            document.getElementById('valorTotal').value = 'R$ ' + formatarMoeda(valorTotal);
        }

        function calcularTotalTabela(tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            let total = 0;
            
            for (const row of tbody.rows) {
                const quantidade = parseFloat(row.cells[1].querySelector('input').value) || 0;
                const valorUnitario = parseMoeda(row.cells[2].querySelector('input').value);
                const valorTotal = quantidade * valorUnitario;
                
                row.cells[3].querySelector('input').value = formatarMoeda(valorTotal);
                total += valorTotal;
            }
            
            return total;
        }

        // ===== GERENCIAMENTO DE TABELAS =====
        function addRow(tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const newRow = tbody.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="Item"></td>
                <td><input type="number" placeholder="1" onchange="calcularTotais()"></td>
                <td><input type="text" placeholder="0,00" onchange="calcularTotais()"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this, 'comercial')">√ó</button></td>
            `;
        }

        // ===== NAVEGA√á√ÉO ENTRE ABAS =====
        function showTab(tabName) {
            // Esconder todas as se√ß√µes
            const sections = document.querySelectorAll('.form-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remover classe active de todas as abas
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(tabName).classList.add('active');
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            
            currentTab = tabName;
            updateProgress();
        }

        function updateProgress() {
            const progressMap = {
                'dados': 25,
                'tecnica': 50,
                'comercial': 75,
                'revisao': 100
            };
            
            const progress = progressMap[currentTab] || 0;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
        }

        // ===== COLETA DE DADOS =====
        function coletarDados() {
            return {
                processo: document.getElementById('numeroProcesso').value,
                objeto: document.getElementById('objetoProcesso').value,
                dados: {
                    razaoSocial: document.getElementById('razaoSocial').value,
                    cnpj: document.getElementById('cnpj').value,
                    endereco: document.getElementById('endereco').value,
                    telefone: document.getElementById('telefone').value,
                    email: document.getElementById('email').value,
                    respTecnico: document.getElementById('respTecnico').value,
                    crea: document.getElementById('crea').value
                },
                tecnica: {
                    objetoConcorrencia: document.getElementById('objetoConcorrencia').value,
                    escopoInclusos: document.getElementById('escopoInclusos').value,
                    escopoExclusos: document.getElementById('escopoExclusos').value,
                    metodologia: document.getElementById('metodologia').value,
                    cronograma: coletarCronograma(),
                    observacoes: document.getElementById('observacoes').value
                },
                comercial: {
                    maoObra: coletarTabela('maoObraTable'),
                    materiais: coletarTabela('materiaisTable'),
                    equipamentos: coletarTabela('equipamentosTable'),
                    totalMaoObra: document.getElementById('totalMaoObra').textContent,
                    totalMateriais: document.getElementById('totalMateriais').textContent,
                    totalEquipamentos: document.getElementById('totalEquipamentos').textContent,
                    bdiPercentual: document.getElementById('bdiPercentual').value,
                    bdiValor: document.getElementById('bdiValor').value,
                    validadeProposta: document.getElementById('validadeProposta').value,
                    validadeDetalhada: document.getElementById('validadeDetalhada').value
                },
                resumo: {
                    prazoExecucao: document.getElementById('prazoExecucao').value,
                    valorTotal: document.getElementById('valorTotal').value
                }
            };
        }

        function coletarCronograma() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            const cronograma = [];
            
            for (const row of tbody.rows) {
                const atividade = row.cells[0].querySelector('input').value;
                const duracao = row.cells[1].querySelector('input').value;
                const inicio = row.cells[2].querySelector('input').value;
                const fim = row.cells[3].querySelector('input').value;
                
                if (atividade && duracao) {
                    cronograma.push({ atividade, duracao, inicio, fim });
                }
            }
            
            return cronograma;
        }

        function coletarTabela(tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const items = [];
            
            for (const row of tbody.rows) {
                const item = row.cells[0].querySelector('input').value;
                const quantidade = row.cells[1].querySelector('input').value;
                const valorUnitario = row.cells[2].querySelector('input').value;
                const valorTotal = row.cells[3].querySelector('input').value;
                
                if (item && quantidade && valorUnitario) {
                    items.push({ item, quantidade, valorUnitario, valorTotal });
                }
            }
            
            return items;
        }

        // ===== ENVIO DA PROPOSTA =====
        async function enviarProposta() {
            const dados = coletarDados();
            
            // Valida√ß√µes b√°sicas
            if (!dados.dados.razaoSocial || !dados.dados.cnpj) {
                alert('Por favor, preencha os campos obrigat√≥rios (Raz√£o Social e CNPJ).');
                showTab('dados');
                return;
            }
            
            if (!dados.processo) {
                alert('Por favor, informe o n√∫mero do processo.');
                return;
            }
            
            try {
                const response = await fetch('/api/enviar-proposta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('mensagem').innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <strong>‚úÖ Proposta enviada com sucesso!</strong><br>
                            Protocolo: <strong>${result.protocolo}</strong><br>
                            Data: ${new Date(result.data_envio).toLocaleString('pt-BR')}
                        </div>
                    `;
                } else {
                    if (result.erro === 'CNPJ_DUPLICADO') {
                        document.getElementById('mensagem').innerHTML = `
                            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                                <strong>‚ö†Ô∏è CNPJ Duplicado</strong><br>
                                ${result.mensagem}
                            </div>
                        `;
                    } else {
                        throw new Error(result.erro || 'Erro desconhecido');
                    }
                }
            } catch (error) {
                console.error('Erro ao enviar proposta:', error);
                document.getElementById('mensagem').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>‚ùå Erro ao enviar proposta</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // ===== PREVIEW E MODAL =====
        function gerarPreview() {
            const dados = coletarDados();
            // Implementar preview se necess√°rio
            alert('Funcionalidade de preview ser√° implementada em breve.');
        }

        function fecharModalRevisao() {
            document.getElementById('modalRevisao').style.display = 'none';
        }

        function habilitarBotaoEnvio() {
            const checkbox = document.getElementById('confirmacaoFinal');
            const botao = document.getElementById('btnConfirmarEnvio');
            
            if (checkbox.checked) {
                botao.disabled = false;
                botao.style.opacity = '1';
            } else {
                botao.disabled = true;
                botao.style.opacity = '0.5';
            }
        }

        function confirmarEnvioFinal() {
            fecharModalRevisao();
            enviarProposta();
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            // Calcular cronograma inicial
            calcularCronograma();
            
            // Calcular totais inicial
            calcularTotais();
            
            // Atualizar progresso
            updateProgress();
            
            // Adicionar formata√ß√£o de moeda aos campos
            const camposMoeda = document.querySelectorAll('input[placeholder*="00"]');
            camposMoeda.forEach(campo => {
                campo.addEventListener('blur', function() {
                    if (this.value) {
                        const valor = parseMoeda(this.value);
                        this.value = formatarMoeda(valor);
                    }
                });
            });
        });
    </script>
</body>
</html>
